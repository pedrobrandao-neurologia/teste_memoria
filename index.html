<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>M@T Digital — Teste de Alteração da Memória (v3.0)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{ --primary:#3b82f6; --primary-600:#2563eb; }
    html,body{height:100%}
    body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue','Noto Sans',sans-serif;background:#f3f4f6}
    .card{background:#fff;border-radius:1rem;box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05);padding:1.25rem}
    @media(min-width:640px){.card{padding:2rem}}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;border:none;border-radius:.75rem;padding:.875rem 1.25rem;font-weight:600;color:#fff;background:var(--primary);cursor:pointer;transition:all .2s}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn:hover:not(:disabled){background:var(--primary-600)}
    .btn-secondary{background:#6b7280}
    .btn-secondary:hover{background:#4b5563}
    .option-grid{display:grid;grid-template-columns:1fr;gap:.75rem}
    @media(min-width:640px){.option-grid{grid-template-columns:repeat(2,1fr)}}
    .option-btn{width:100%;padding:1rem;border:2px solid #e5e7eb;border-radius:.75rem;background:#f9fafb;text-align:left;cursor:pointer;transition:.15s}
    .option-btn:hover:not(:disabled){background:#f3f4f6;border-color:var(--primary)}
    .option-btn.selected{background:#dbeafe;border-color:var(--primary);font-weight:600}
    .option-btn.correct{background:#dcfce7;border-color:#22c55e;color:#166534;font-weight:700}
    .option-btn.incorrect{background:#fee2e2;border-color:#ef4444;color:#991b1b}
    .option-btn:disabled{opacity:.7;cursor:not-allowed}
    .input{width:100%;padding:.75rem 1rem;border:2px solid #e5e7eb;border-radius:.75rem}
    .input:focus{outline:none;border-color:var(--primary)}
    .progress{height:.5rem;background:#e5e7eb;border-radius:9999px;overflow:hidden}
    .progress > div{height:100%;background:var(--primary);width:0%;transition:width .3s ease}
    .badge-audio{display:none;align-items:center;gap:.4rem;background:#fef3c7;border:1px solid #fbbf24;color:#92400e;padding:.25rem .6rem;border-radius:9999px;font-size:.875rem}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
    .pulse{animation:pulse 2s infinite}
  </style>
</head>
<body class="min-h-screen p-4 grid place-items-center">
  <main id="app" class="card w-full max-w-[760px]"></main>

  <script>
    // ==============================
    // CONFIGURAÇÃO DO TESTE
    // ==============================
    const TEST_VERSION = 'MAT-Digital v3.0.0';
    const ISI_MS = 600;            // Intervalo entre estímulos (palavras)
    const SENTENCE_ISI_MS = 1200;  // Intervalo após frase
    const MAX_FREE_RECALL_WORDS = 5;

    // Estrutura de blocos (conteúdo semelhante ao seu, com ajustes mínimos)
    const blocks = {
      codificacao: [
        {type:'instruction', text:'Agora vou dizer 5 palavras. Ouça com atenção e tente memorizá-las.'},
        {type:'word', item:'Cereja'},
        {type:'word', item:'Machado'},
        {type:'word', item:'Elefante'},
        {type:'word', item:'Piano'},
        {type:'word', item:'Verde'},
        {type:'instruction', text:'Agora responda às perguntas.'},
        {type:'mc', prompt:'Eu lhe disse o nome de uma fruta, qual era?', options:['Maçã','Cereja','Banana','Uva'], answer:'Cereja', cue:'Qual era a fruta?'},
        {type:'mc', prompt:'Eu lhe disse o nome de uma ferramenta, qual era?', options:['Serrote','Alicate','Machado','Martelo'], answer:'Machado', cue:'Qual era a ferramenta?'},
        {type:'mc', prompt:'Eu lhe disse o nome de um animal, qual era?', options:['Cachorro','Gato','Leão','Elefante'], answer:'Elefante', cue:'Qual era o animal?'},
        {type:'mc', prompt:'Eu lhe disse o nome de um instrumento musical, qual era?', options:['Violino','Piano','Flauta','Bateria'], answer:'Piano', cue:'Qual era o instrumento musical?'},
        {type:'mc', prompt:'Eu lhe disse o nome de uma cor, qual era?', options:['Azul','Vermelho','Verde','Amarelo'], answer:'Verde', cue:'Qual era a cor?'},
        {type:'instruction', text:'Agora ouça a primeira frase.'},
        {type:'sentence', sentence:'Trinta gatos cinzas comeram todo o queijo.'},
        {type:'mc-sent', ref:'Trinta gatos cinzas comeram todo o queijo.', questions:[
          {prompt:'Da frase sobre os gatos, quantos gatos eram?', options:['Vinte','Trinta','Quarenta'], answer:'Trinta'},
          {prompt:'Qual era a cor dos gatos?', options:['Pretos','Brancos','Cinzas'], answer:'Cinzas'},
          {prompt:'O que eles comeram?', options:['Ração','Peixe','Queijo'], answer:'Queijo'}
        ], recall_items:['Trinta','Cinzas','Queijo']},
        {type:'instruction', text:'Agora ouça a segunda frase.'},
        {type:'sentence', sentence:'Um garoto chamado Luís estava brincando com sua bicicleta.'},
        {type:'mc-sent', ref:'Um garoto chamado Luís estava brincando com sua bicicleta.', questions:[
          {prompt:'Da frase sobre o garoto, qual era o nome dele?', options:['Pedro','Luís','João'], answer:'Luís'},
          {prompt:'Com o que ele estava brincando?', options:['Bola','Carrinho','Bicicleta'], answer:'Bicicleta'}
        ], recall_items:['Luís','Bicicleta']},
      ],
      orientacao: [
        {type:'mc-dyn', prompt:'Que dia da semana é hoje?', get:'dayOfWeek'},
        {type:'mc-dyn', prompt:'Em que mês estamos?', get:'month'},
        {type:'input-dyn', prompt:'Qual é o dia do mês?', get:'dayOfMonth', input:'number'},
        {type:'input-dyn', prompt:'Em que ano estamos?', get:'year', input:'number'},
        {type:'mc-dyn', prompt:'Qual é a estação do ano?', get:'season'}
      ],
      semantica: [
        {type:'mc', prompt:'Qual profissional conserta carros?', options:['Mecânico','Eletricista','Encanador','Padeiro','Jardineiro'], answer:'Mecânico'},
        {type:'mc', prompt:'Qual é o último dia do ano?', options:['31 de Dezembro','30 de Dezembro','1 de Janeiro','25 de Dezembro','31 de Janeiro'], answer:'31 de Dezembro'},
        {type:'mc', prompt:'Quantas gramas há em um quarto de quilo?', options:['250g','500g','100g','750g','1000g'], answer:'250g'},
        {type:'mc', prompt:'Qual é o oitavo mês do ano?', options:['Agosto','Setembro','Julho','Outubro','Junho'], answer:'Agosto'},
        {type:'mc', prompt:'Em que mês comemoramos o Natal?', options:['Novembro','Janeiro','Dezembro','Fevereiro','Março'], answer:'Dezembro'},
        {type:'mc', prompt:'Se o ponteiro grande de um relógio está no 11, quantos minutos ele marca?', options:['55 minutos','11 minutos','50 minutos','5 minutos','60 minutos'], answer:'55 minutos'},
        {type:'mc', prompt:'Qual estação do ano vem depois do verão?', options:['Outono','Inverno','Primavera'], answer:'Outono'},
        {type:'mc', prompt:'Que animal rasteja e não tem patas?', options:['Cachorro','Pássaro','Serpente','Peixe','Minhoca'], answer:'Serpente'},
        {type:'mc', prompt:'Azeitona vem de qual árvore?', options:['Videira','Oliveira','Macieira','Cerejeira','Laranjeira'], answer:'Oliveira'},
        {type:'mc', prompt:'De qual fruto se faz o chocolate?', options:['Café','Cacau','Morango','Cana-de-açúcar','Soja'], answer:'Cacau'},
        {type:'mc', prompt:'Qual o triplo de doze?', options:['24','36','48','30','15'], answer:'36'},
        {type:'mc', prompt:'Quantas horas há em dois dias?', options:['24 horas','36 horas','48 horas','72 horas','60 horas'], answer:'48 horas'},
        {type:'mc', prompt:'O que usamos para escrever em um quadro negro?', options:['Caneta','Giz','Lápis','Pincel','Tinta'], answer:'Giz'},
        {type:'mc', prompt:'Qual é a capital do Brasil?', options:['Rio de Janeiro','São Paulo','Brasília','Salvador','Belo Horizonte'], answer:'Brasília'},
        {type:'mc', prompt:'Quantos lados tem um triângulo?', options:['Três','Quatro','Cinco'], answer:'Três'}
      ]
    };

    // Fluxo inclui blocos especiais não armazenados em "blocks"
    const FLOW = ['codificacao','orientacao','semantica','free_recall','cued_recall'];

    // ==============================
    // ESTADO GLOBAL
    // ==============================
    const app = document.getElementById('app');
    const state = {
      screen:'welcome',
      profile:{ age:'', education:'' },
      block:null, itemIndex:0, subIndex:0,
      startTime:null, endTime:null,
      answers:{}, scores:{ codificacao:0, orientacao:0, semantica:0, recuperacao_livre:0, recuperacao_pistas:0 },
      itemsToRecall:[], recallPhase:'words',
      selection:null, lastShownAt:null, rtLog:[], qc:[],
      ttsReady:false, // desbloqueio por gesto do usuário
    };

    // ==============================
    // UTILITÁRIOS
    // ==============================
    const $ = (sel,root=document) => root.querySelector(sel);
    const $$ = (sel,root=document) => [...root.querySelectorAll(sel)];
    const shuffle = (arr)=>{const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a};

    const dynamic = (kind)=>{
      const now = new Date();
      const week = ['Domingo','Segunda-feira','Terça-feira','Quarta-feira','Quinta-feira','Sexta-feira','Sábado'];
      const months = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
      const m = now.getMonth();
      let season;
      // Hemisfério Sul (Brasil)
      if (m===11||m<=1) season='Verão';
      else if (m>=2 && m<=4) season='Outono';
      else if (m>=5 && m<=7) season='Inverno';
      else season='Primavera';
      switch(kind){
        case 'dayOfWeek': return { options:week, answer:week[now.getDay()] };
        case 'month': return { options:months, answer:months[m] };
        case 'season': return { options:['Verão','Outono','Inverno','Primavera'], answer:season };
        case 'dayOfMonth': return { answer:String(now.getDate()) };
        case 'year': return { answer:String(now.getFullYear()) };
        default: return {};
      }
    };

    // ==============================
    // TTS (APENAS Web Speech API — sem serviços externos)
    // ==============================
    const tts = {
      enabled: true,
      speakQueue: Promise.resolve(),
      ensureReady(){
        if (!('speechSynthesis' in window)) { this.enabled=false; return; }
        try {
          // desbloqueio com gesto: falar curto após botão "Iniciar"
          window.speechSynthesis.cancel();
          const u = new SpeechSynthesisUtterance('');
          u.lang = 'pt-BR';
          window.speechSynthesis.speak(u);
          state.ttsReady = true;
        } catch (_) { this.enabled=false; }
      },
      pickVoice(){
        const voices = window.speechSynthesis?.getVoices?.() || [];
        const pt = voices.filter(v=>/pt-BR/i.test(v.lang));
        // Preferências comuns: Luciana, Felipe (macOS/iOS), Google pt-BR (Chrome)
        return pt.find(v=>/Luciana|Felipe|Google/.test(v.name)) || pt.find(v=>v.default) || pt[0] || null;
      },
      say(text, {rate=1.05, onend}={}){
        const badge = $('#badge-audio');
        if (badge) badge.style.display='inline-flex';
        if (!this.enabled || !state.ttsReady) { if (badge) badge.style.display='none'; if (onend) onend(); return; }
        this.speakQueue = this.speakQueue.then(()=> new Promise(res=>{
          window.speechSynthesis.cancel();
          const u = new SpeechSynthesisUtterance(text);
          u.lang='pt-BR'; u.rate=rate; u.voice=this.pickVoice();
          u.onend=()=>{ if (badge) badge.style.display='none'; if (onend) onend(); res(); };
          u.onerror=()=>{ if (badge) badge.style.display='none'; res(); };
          window.speechSynthesis.speak(u);
        }));
      }
    };

    // ==============================
    // RENDERIZAÇÃO BÁSICA
    // ==============================
    function header(title, showProgress=true){
      let pct = 0;
      if (showProgress && state.block){
        // total de itens = soma de blocos "blocks" + etapas especiais (2 etapas no recall)
        const totalStandard = Object.values(blocks).reduce((acc, arr)=> acc+arr.length,0);
        const special = 2; // free_recall + cued_recall
        const total = totalStandard + special;
        const currentBlockIndex = FLOW.indexOf(state.block);
        // itens completados em blocos anteriores (apenas os existentes em blocks)
        const donePrev = FLOW.slice(0,currentBlockIndex).reduce((acc,b)=> acc + (blocks[b]?.length||1),0);
        pct = Math.min(100, ((donePrev + (state.itemIndex||0)) / total) * 100);
      }
      return `
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-bold text-gray-800">${title}</h1>
            <p class="text-xs text-gray-500">${TEST_VERSION}</p>
          </div>
          <div id="badge-audio" class="badge-audio pulse"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>Reproduzindo</div>
        </div>
        ${showProgress?`<div class="mt-4 progress"><div style="width:${pct}%"></div></div>`:'<div class="mt-6"></div>'}
      `;
    }

    function render(){
      switch(state.screen){
        case 'welcome': return renderWelcome();
        case 'profile': return renderProfile();
        case 'instructions': return renderInstructions();
        case 'test': return renderTest();
        case 'results': return renderResults();
      }
    }

    function renderWelcome(){
      app.innerHTML = `
        <section class="text-center">
          <h1 class="text-3xl font-bold text-gray-800">M@T Digital</h1>
          <p class="text-gray-600 mb-6">Teste de Alteração da Memória</p>
          <div class="text-left bg-blue-50 border border-blue-200 text-blue-900 rounded p-4 mb-6">
            <p class="font-semibold mb-2">Antes de começar:</p>
            <ul class="list-disc list-inside text-sm space-y-1">
              <li>Ambiente silencioso, sem interrupções.</li>
              <li>Duração aproximada: 10–15 minutos.</li>
              <li>Áudio necessário para instruções. Teste abaixo.</li>
            </ul>
          </div>
          <div class="flex items-center justify-center gap-3 mb-6">
            <button class="btn-secondary btn" data-action="test-audio">🔊 Testar áudio</button>
            <button class="btn" data-action="start-profile">Iniciar</button>
          </div>
        </section>
      `;
    }

    function renderProfile(){
      app.innerHTML = `
        ${header('Informações do Participante', false)}
        <div class="space-y-4">
          <label class="block">
            <span class="block text-sm font-medium text-gray-700">Idade (anos completos) <span class="text-red-500">*</span></span>
            <input id="age" type="number" min="18" max="120" class="input" value="${state.profile.age}" />
          </label>
          <label class="block">
            <span class="block text-sm font-medium text-gray-700">Escolaridade (anos de estudo) <span class="text-red-500">*</span></span>
            <input id="education" type="number" min="0" max="40" class="input" value="${state.profile.education}" />
          </label>
          <p id="profile-error" class="text-sm text-red-600 min-h-[20px]"></p>
          <div class="flex justify-end gap-3">
            <button class="btn-secondary btn" data-action="back">Voltar</button>
            <button class="btn" data-action="go-instructions">Continuar</button>
          </div>
        </div>
      `;
    }

    function renderInstructions(){
      const text = 'O teste começará agora. Você verá e ouvirá palavras, frases e perguntas. Responda tocando nos botões. Se não souber, selecione “Não me recordo”, quando disponível.';
      app.innerHTML = `
        ${header('Instruções', false)}
        <p class="text-gray-700 text-lg">${text}</p>
        <div class="mt-4 bg-yellow-50 border border-yellow-200 text-yellow-900 rounded p-3">
          <p class="font-semibold">Atenção</p>
          <p class="text-sm">Não use o botão voltar do navegador nem recarregue a página.</p>
        </div>
        <div class="flex justify-end gap-3 mt-6">
          <button class="btn-secondary btn" data-action="back-profile">Voltar</button>
          <button class="btn" data-action="start-test">Começar o teste</button>
        </div>
      `;
      tts.say(text);
    }

    function renderTest(){
      switch(state.block){
        case 'codificacao':
        case 'orientacao':
        case 'semantica':
          return renderQuestionBlock(state.block);
        case 'free_recall':
          return renderFreeRecall();
        case 'cued_recall':
          return renderCuedRecall();
      }
    }

    function renderQuestionBlock(blockName){
      const arr = blocks[blockName];
      const item = arr[state.itemIndex];
      if (!item) { // segurança
        return goNext();
      }
      state.selection = null;
      state.lastShownAt = performance.now();

      let inner = '';
      const titleMap = {codificacao:'Memorização', orientacao:'Orientação no Tempo', semantica:'Conhecimentos Gerais'};
      const title = titleMap[blockName] || 'Teste';

      if (item.type === 'instruction'){
        inner = `
          ${header(title)}
          <p class="text-xl text-center my-8">${item.text}</p>
          <div class="text-center mt-6"><button class="btn" data-action="next">Continuar</button></div>
        `;
        tts.say(item.text);
      }
      else if (item.type === 'word'){
        inner = `
          ${header(title)}
          <div class="text-center my-16"><h2 class="text-5xl font-bold text-gray-800">${item.item}</h2></div>
        `;
        tts.say(item.item, { onend: ()=> setTimeout(goNext, ISI_MS) });
      }
      else if (item.type === 'sentence'){
        inner = `
          ${header(title)}
          <div class="text-center my-12 px-4"><h2 class="text-3xl font-semibold text-gray-800 leading-relaxed">${item.sentence}</h2></div>
        `;
        tts.say(item.sentence, { onend: ()=> setTimeout(goNext, SENTENCE_ISI_MS) });
      }
      else if (item.type === 'mc' || item.type === 'mc-sent' || item.type === 'mc-dyn' || item.type === 'input-dyn'){
        inner = questionUI(blockName, item);
      }

      app.innerHTML = inner;
    }

    function questionUI(blockName, item){
      let prompt, opts = null, kind='mc', inputType='text', dynAns=null;
      if (item.type === 'mc'){
        prompt = item.prompt; opts = shuffle([...item.options, 'Não me recordo']);
      } else if (item.type === 'mc-sent'){
        const q = item.questions[state.subIndex];
        prompt = q.prompt; opts = shuffle([...q.options, 'Não me recordo']);
      } else if (item.type === 'mc-dyn'){
        const d = dynamic(item.get); prompt = item.prompt; dynAns = d.answer; opts = shuffle([...d.options, 'Não me recordo']);
      } else if (item.type === 'input-dyn'){
        const d = dynamic(item.get); prompt = item.prompt; dynAns = d.answer; kind='input'; inputType=item.input||'text';
      }

      tts.say(prompt);
      return `
        ${header({codificacao:'Memorização', orientacao:'Orientação no Tempo', semantica:'Conhecimentos Gerais'}[blockName])}
        <p class="text-xl text-gray-700 mb-6 min-h-[60px]">${prompt}</p>
        ${kind==='mc' ? `
          <div class="option-grid">
            ${opts.map(o=>`<button class="option-btn" data-action="choose" data-value="${encodeURIComponent(o)}">${o}</button>`).join('')}
          </div>
        `: `
          <div><input id="free-input" class="input" type="${inputType}" placeholder="Digite sua resposta" autocomplete="off" /></div>
        `}
        <div class="mt-8 text-right">
          <button class="btn" data-action="submit" ${kind==='mc'?'disabled':''}>Confirmar</button>
        </div>
        ${dynAns!==null?`<span class="hidden" id="dyn-answer" data-ans="${encodeURIComponent(dynAns)}"></span>`:''}
      `;
    }

    // ==============================
    // EVOCAÇÃO LIVRE
    // ==============================
    function buildRecallPool(){
      // Palavras a recordar
      const words = blocks.codificacao.filter(i=>i.type==='mc').map(i=>({cue:i.cue, answer:i.answer, source:'word', recalled:null}));
      // Frases
      const sentSets = blocks.codificacao.filter(i=>i.type==='mc-sent');
      const sentItems = sentSets.flatMap((s,idx)=> s.recall_items.map(x=>({cue:`Da frase sobre ${idx===0?'os gatos':'o garoto'}`, answer:x, source:`sentence_${idx+1}`, recalled:null})));
      state.itemsToRecall = [...words, ...sentItems];
    }

    function renderFreeRecall(){
      if (state.recallPhase==='words') return renderFreeRecallWords();
      return renderFreeRecallSentences();
    }

    function renderFreeRecallWords(){
      const text = 'Agora, selecione as 5 palavras que você memorizou no início do teste.';
      const words = state.itemsToRecall.filter(i=>i.source==='word').map(i=>i.answer);
      const distractors = ['Maçã','Martelo','Cachorro','Violino','Azul','Pera','Chave','Tigre','Harpa','Roxo','Copo','Livro','Porta','Caneta','Garfo'];
      const pool = shuffle([...words, ...shuffle(distractors).slice(0,15)]);
      tts.say(text);
      app.innerHTML = `
        ${header('Evocação Livre — Palavras')}
        <p class="text-gray-700 mb-2">${text}</p>
        <div class="text-sm text-gray-600 mb-3">Toque para selecionar (máx. ${MAX_FREE_RECALL_WORDS}).</div>
        <div id="recall-grid" class="grid grid-cols-2 sm:grid-cols-4 gap-3">
          ${pool.map(o=>`<button class="option-btn text-center" data-action="toggle-recall" data-kind="word">${o}</button>`).join('')}
        </div>
        <div class="mt-3 text-right text-sm">Selecionadas: <span id="sel-count" class="font-semibold">0</span> / ${MAX_FREE_RECALL_WORDS}</div>
        <div class="mt-6 text-right"><button class="btn" data-action="commit-recall-words">Confirmar seleção</button></div>
      `;
    }

    function renderFreeRecallSentences(){
      const text = 'Agora, selecione as palavras que você se lembra das duas frases apresentadas.';
      const items = state.itemsToRecall.filter(i=>/sentence_/.test(i.source)).map(i=>i.answer);
      const distractors = ['Vinte','Pretos','Ração','Pedro','Bola','Cão','Gata','Quarenta'];
      const pool = shuffle([...items, ...distractors]);
      tts.say(text);
      app.innerHTML = `
        ${header('Evocação Livre — Frases')}
        <p class="text-gray-700 mb-2">${text}</p>
        <div class="text-sm text-gray-600 mb-3">Selecione todas as palavras que lembrar.</div>
        <div id="recall-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
          ${pool.map(o=>`<button class="option-btn text-center" data-action="toggle-recall" data-kind="sent">${o}</button>`).join('')}
        </div>
        <div class="mt-6 text-right"><button class="btn" data-action="commit-recall-sent">Confirmar e continuar</button></div>
      `;
    }

    // ==============================
    // EVOCAÇÃO COM PISTAS
    // ==============================
    function renderCuedRecall(){
      const pending = state.itemsToRecall.find(i=>!i.recalled);
      if (!pending){
        return goNext();
      }
      const distractorMap = {
        fruta:['Maçã','Banana','Uva'], ferramenta:['Serrote','Martelo','Alicate'],
        animal:['Gato','Leão','Cachorro'], instrumento:['Violino','Flauta','Guitarra'],
        cor:['Azul','Amarelo','Vermelho'], gatos:['Vinte','Pretos','Ração'], garoto:['Pedro','Bola','Carrinho']
      };
      const key = Object.keys(distractorMap).find(k=> pending.cue.toLowerCase().includes(k));
      const distract = (key? distractorMap[key]: ['Opção A','Opção B']).filter(d=>d!==pending.answer);
      const opts = shuffle([pending.answer, ...shuffle(distract).slice(0,3), 'Não me recordo']);

      tts.say(pending.cue);
      app.innerHTML = `
        ${header('Evocação com Pistas')}
        <p class="text-xl text-gray-700 mb-6">${pending.cue}</p>
        <div class="option-grid">
          ${opts.map(o=>`<button class="option-btn" data-action="choose" data-value="${encodeURIComponent(o)}">${o}</button>`).join('')}
        </div>
        <div class="mt-8 text-right"><button class="btn" data-action="submit-cued" data-item="${encodeURIComponent(JSON.stringify(pending))}" disabled>Confirmar</button></div>
      `;
    }

    // ==============================
    // LÓGICA DE FLUXO
    // ==============================
    function startTest(){
      state.startTime = new Date();
      state.screen = 'test';
      state.block = FLOW[0];
      state.itemIndex = 0; state.subIndex = 0;
      buildRecallPool();
      render();
    }

    function goNext(){
      // avança dentro do bloco atual
      if (blocks[state.block]){
        const arr = blocks[state.block];
        const curr = arr[state.itemIndex];
        if (curr?.type==='mc-sent' && state.subIndex < curr.questions.length-1){
          state.subIndex++;
        } else {
          state.itemIndex++; state.subIndex = 0;
        }
        if (state.itemIndex < arr.length){ render(); return; }
      }
      // fim do bloco -> próximo
      const i = FLOW.indexOf(state.block);
      if (i < FLOW.length-1){
        state.block = FLOW[i+1];
        state.itemIndex = 0; state.subIndex = 0;
        render(); return;
      }
      // fim do teste
      state.endTime = new Date();
      state.screen = 'results';
      render();
    }

    function scoreAndLog(answer, correct, domain){
      const now = performance.now();
      const rt = Math.max(0, now - (state.lastShownAt||now));
      state.rtLog.push({block:domain, item:state.itemIndex, sub:state.subIndex, answer, correct, rt});
      if (rt < 300) state.qc.push(`Resposta muito rápida (${Math.round(rt)}ms) em ${domain}-${state.itemIndex}`);
      const ok = String(answer).trim().toLowerCase() === String(correct).trim().toLowerCase();
      if (ok) state.scores[domain]++;
      const key = `${domain}-${state.itemIndex}-${state.subIndex}`;
      state.answers[key] = {given:answer, correct, isCorrect:ok, rt};
    }

    // ==============================
    // EXPORTAÇÃO
    // ==============================
    function exportData(){
      const total = Object.values(state.scores).reduce((a,b)=>a+b,0);
      return {
        version: TEST_VERSION,
        testDate: state.startTime?.toISOString?.()||'',
        durationSec: state.endTime? Math.round((state.endTime - state.startTime)/1000):0,
        profile: state.profile,
        scores: {
          codificacao: {score:state.scores.codificacao, max:10},
          orientacao: {score:state.scores.orientacao, max:5},
          semantica: {score:state.scores.semantica, max:15},
          recuperacao_livre: {score:state.scores.recuperacao_livre, max:10},
          recuperacao_pistas: {score:state.scores.recuperacao_pistas, max:10},
          total: {score:total, max:50}
        },
        qc: state.qc,
        answers: state.answers,
        recall: state.itemsToRecall,
        rt: state.rtLog
      };
    }

    function download(filename, content, type){
      const blob = new Blob([content], {type});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // ==============================
    // RESULTADOS
    // ==============================
    function renderResults(){
      const data = exportData();
      const total = data.scores.total.score;
      const duration = data.durationSec; const mm = Math.floor(duration/60); const ss = duration%60;
      const row = (label, sc, max, strong=false)=>`
        <div class="flex justify-between items-center ${strong?'bg-blue-100 border-2 border-blue-300':'bg-gray-50'} p-3 rounded-lg">
          <span class="${strong?'font-bold text-blue-800':'font-semibold text-gray-700'}">${label}</span>
          <span class="${strong?'text-xl font-bold text-blue-800':'text-lg font-bold text-gray-800'}">${sc} / ${max}</span>
        </div>`;
      app.innerHTML = `
        <div class="text-center">
          <h2 class="text-3xl font-bold text-gray-800 mb-1">Teste concluído</h2>
          <p class="text-gray-600 mb-6">Tempo total: ${mm}m ${ss}s</p>
        </div>
        <div class="space-y-3">
          ${row('Memorização (Codificação)', data.scores.codificacao.score, data.scores.codificacao.max)}
          ${row('Orientação no Tempo', data.scores.orientacao.score, data.scores.orientacao.max)}
          ${row('Conhecimentos Gerais', data.scores.semantica.score, data.scores.semantica.max)}
          ${row('Evocação Livre', data.scores.recuperacao_livre.score, data.scores.recuperacao_livre.max)}
          ${row('Evocação com Pistas', data.scores.recuperacao_pistas.score, data.scores.recuperacao_pistas.max)}
          ${row('PONTUAÇÃO TOTAL', total, data.scores.total.max, true)}
        </div>
        ${state.qc.length?`
        <div class="mt-6 p-3 bg-yellow-50 border-l-4 border-yellow-400 text-yellow-900 rounded">
          <h4 class="font-bold mb-2">Observações de Qualidade</h4>
          <ul class="list-disc list-inside text-sm space-y-1">${state.qc.map(x=>`<li>${x}</li>`).join('')}</ul>
        </div>`:''}
        <div class="mt-8">
          <h3 class="text-lg font-semibold text-center mb-3">Exportar resultados</h3>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
            <button class="btn-secondary btn" data-action="export-json">💾 JSON</button>
            <button class="btn-secondary btn" data-action="export-csv">📊 CSV</button>
            <button class="btn-secondary btn" data-action="export-pdf">📄 PDF</button>
          </div>
        </div>
        <div class="mt-8 text-center"><button class="btn" data-action="restart">Novo teste</button></div>
        <div class="mt-6 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800">
          <p class="font-semibold mb-1">Nota importante:</p>
          <p>Este é um teste de rastreio cognitivo. A interpretação dos resultados deve ser realizada por profissional habilitado.</p>
        </div>
      `;
    }

    // ==============================
    // EVENTOS
    // ==============================
    app.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('[data-action]'); if(!btn) return;
      const act = btn.getAttribute('data-action');
      if (act==='test-audio'){
        tts.ensureReady();
        tts.say('Teste de áudio habilitado. Você ouvirá as instruções durante o exame.');
      }
      else if (act==='start-profile'){ state.screen='profile'; render(); }
      else if (act==='back'){ state.screen='welcome'; render(); }
      else if (act==='go-instructions'){
        const age = $('#age').value.trim(); const edu = $('#education').value.trim();
        const err = $('#profile-error');
        if (!age || !edu){ err.textContent='Preencha todos os campos obrigatórios.'; return; }
        state.profile.age = age; state.profile.education = edu; state.screen='instructions'; render();
      }
      else if (act==='back-profile'){ state.screen='profile'; render(); }
      else if (act==='start-test'){
        tts.ensureReady(); startTest();
      }
      else if (act==='next'){ goNext(); }
      else if (act==='choose'){
        state.selection = decodeURIComponent(btn.getAttribute('data-value'));
        $$('.option-btn').forEach(b=>b.classList.remove('selected'));
        btn.classList.add('selected');
        const submit = $('[data-action="submit"], [data-action="submit-cued"]');
        if (submit){ submit.disabled=false; }
      }
      else if (act==='submit'){
        const arr = blocks[state.block]; const item = arr[state.itemIndex];
        let given = state.selection;
        if (item.type==='input-dyn'){
          given = ($('#free-input')?.value||'').trim();
          if (!given){ return; }
        }
        // Determinar resposta correta
        let correct;
        if (item.type==='mc') correct = item.answer;
        else if (item.type==='mc-sent') correct = item.questions[state.subIndex].answer;
        else if (item.type==='mc-dyn' || item.type==='input-dyn') correct = decodeURIComponent($('#dyn-answer').getAttribute('data-ans'));
        scoreAndLog(given, correct, state.block);
        if (state.block==='codificacao' && (item.type==='mc' || item.type==='mc-sent')){
          // feedback visual breve
          $$('.option-btn').forEach(b=>{
            const val = decodeURIComponent(b.getAttribute('data-value'));
            b.disabled = true;
            if (val.toLowerCase()===String(correct).toLowerCase()) b.classList.add('correct');
            else if (val===state.selection) b.classList.add('incorrect');
          });
          const msg = (String(given).toLowerCase()===String(correct).toLowerCase())? 'Correto.' : `A resposta correta era: ${correct}.`;
          tts.say(msg, { onend: ()=> setTimeout(()=>{ goNext(); }, 500) });
        } else {
          goNext();
        }
      }
      else if (act==='toggle-recall'){
        btn.classList.toggle('selected');
        if (btn.getAttribute('data-kind')==='word'){
          const sel = $$('#recall-grid .option-btn.selected');
          if (sel.length > MAX_FREE_RECALL_WORDS){ btn.classList.remove('selected'); return; }
          $('#sel-count').textContent = String(sel.length);
          const rest = $$('#recall-grid .option-btn:not(.selected)');
          rest.forEach(x=>{ x.disabled = sel.length>=MAX_FREE_RECALL_WORDS; });
        }
      }
      else if (act==='commit-recall-words'){
        const chosen = $$('#recall-grid .option-btn.selected').map(b=>b.textContent.trim());
        chosen.forEach(w=>{
          const it = state.itemsToRecall.find(i=>i.source==='word' && !i.recalled && i.answer.toLowerCase()===w.toLowerCase());
          if (it){ it.recalled='free'; state.scores.recuperacao_livre++; }
        });
        state.recallPhase='sent'; render();
      }
      else if (act==='commit-recall-sent'){
        const chosen = $$('#recall-grid .option-btn.selected').map(b=>b.textContent.trim());
        chosen.forEach(w=>{
          const it = state.itemsToRecall.find(i=>/sentence_/.test(i.source) && !i.recalled && i.answer.toLowerCase()===w.toLowerCase());
          if (it){ it.recalled='free'; state.scores.recuperacao_livre++; }
        });
        goNext();
      }
      else if (act==='submit-cued'){
        const raw = btn.getAttribute('data-item');
        const item = JSON.parse(decodeURIComponent(raw));
        const ans = state.selection || '';
        const ok = ans.toLowerCase() === item.answer.toLowerCase();
        if (!state.itemsToRecall.find(i=>i.cue===item.cue && i.answer===item.answer)?.recalled){
          if (ok) state.scores.recuperacao_pistas++;
          const ref = state.itemsToRecall.find(i=>i.cue===item.cue && i.answer===item.answer);
          if (ref) ref.recalled = 'cued';
        }
        state.selection = null;
        renderCuedRecall();
      }
      else if (act==='restart'){
        if (confirm('Reiniciar o teste? O progresso atual será perdido.')){ Object.assign(state, {
          screen:'welcome', profile:{age:'',education:''}, block:null, itemIndex:0, subIndex:0, startTime:null, endTime:null,
          answers:{}, scores:{codificacao:0, orientacao:0, semantica:0, recuperacao_livre:0, recuperacao_pistas:0},
          itemsToRecall:[], recallPhase:'words', selection:null, lastShownAt:null, rtLog:[], qc:[], ttsReady:state.ttsReady
        }); render(); }
      }
      else if (act==='export-json'){
        const d = exportData(); const ts = new Date().toISOString().replace(/[:.]/g,'-');
        download(`MAT_Digital_${ts}.json`, JSON.stringify(d,null,2), 'application/json');
      }
      else if (act==='export-csv'){
        const d = exportData(); const ts = new Date().toISOString().replace(/[:.]/g,'-');
        let csv = 'Dominio,Pontuacao,Maximo,Percentual\n';
        const rows = [ ['Codificacao', d.scores.codificacao.score, d.scores.codificacao.max],
                       ['Orientacao', d.scores.orientacao.score, d.scores.orientacao.max],
                       ['Semantica', d.scores.semantica.score, d.scores.semantica.max],
                       ['Recuperacao Livre', d.scores.recuperacao_livre.score, d.scores.recuperacao_livre.max],
                       ['Recuperacao Pistas', d.scores.recuperacao_pistas.score, d.scores.recuperacao_pistas.max],
                       ['Total', d.scores.total.score, d.scores.total.max] ];
        rows.forEach(([k,sc,max])=>{ const pct=((sc/max)*100).toFixed(1)+'%'; csv+=`${k},${sc},${max},${pct}\n`; });
        csv += '\nPerfil\n';
        csv += `Idade,${d.profile.age}\n`;
        csv += `Escolaridade,${d.profile.education}\n`;
        csv += `Data,${new Date(d.testDate||Date.now()).toLocaleString('pt-BR')}\n`;
        download(`MAT_Digital_${ts}.csv`, csv, 'text/csv;charset=utf-8;');
      }
      else if (act==='export-pdf'){
        // Gera PDF simples via canvas print (sem libs externas, para máxima compatibilidade)
        // Dica: para relatórios completos, conectar jsPDF externamente; aqui mantemos mínimo.
        const d = exportData(); const ts = new Date().toISOString().replace(/[:.]/g,'-');
        const win = window.open('', '_blank');
        const html = `<!doctype html><title>Relatório</title><meta charset="utf-8" />
          <style>body{font-family:Arial,Helvetica,sans-serif;padding:24px} h1{font-size:20px}
          table{border-collapse:collapse;margin-top:10px} td,th{border:1px solid #ccc;padding:6px 10px}
          .muted{color:#666;font-size:12px}</style>
          <h1>M@T Digital — Relatório</h1>
          <div class="muted">${TEST_VERSION}</div>
          <p><b>Data:</b> ${new Date(d.testDate||Date.now()).toLocaleString('pt-BR')}</p>
          <p><b>Idade:</b> ${d.profile.age} &nbsp; <b>Escolaridade:</b> ${d.profile.education}</p>
          <p><b>Duração:</b> ${Math.floor(d.durationSec/60)}m ${d.durationSec%60}s</p>
          <table><thead><tr><th>Domínio</th><th>Pontuação</th><th>Máximo</th></tr></thead>
          <tbody>
           <tr><td>Codificação</td><td>${d.scores.codificacao.score}</td><td>${d.scores.codificacao.max}</td></tr>
           <tr><td>Orientação</td><td>${d.scores.orientacao.score}</td><td>${d.scores.orientacao.max}</td></tr>
           <tr><td>Semântica</td><td>${d.scores.semantica.score}</td><td>${d.scores.semantica.max}</td></tr>
           <tr><td>Evocação Livre</td><td>${d.scores.recuperacao_livre.score}</td><td>${d.scores.recuperacao_livre.max}</td></tr>
           <tr><td>Evocação com Pistas</td><td>${d.scores.recuperacao_pistas.score}</td><td>${d.scores.recuperacao_pistas.max}</td></tr>
           <tr><td><b>Total</b></td><td><b>${d.scores.total.score}</b></td><td><b>${d.scores.total.max}</b></td></tr>
          </tbody></table>
          ${d.qc.length?`<h3>Observações de qualidade</h3><ul>${d.qc.map(x=>`<li>${x}</li>`).join('')}</ul>`:''}
          <p class="muted">Este é um teste de rastreio; interpretar clinicamente com cautela.</p>`;
        win.document.write(html); win.document.close(); win.focus(); win.print();
      }
    });

    app.addEventListener('keypress', (e)=>{
      if (e.key==='Enter' && e.target.id==='free-input'){
        const submit = $('[data-action="submit"]'); if (submit && !submit.disabled) submit.click();
      }
    });

    // Qualidade: saída da aba
    document.addEventListener('visibilitychange', ()=>{
      if (document.hidden && state.screen==='test'){
        state.qc.push(`Saiu da aba às ${new Date().toLocaleTimeString('pt-BR')}`);
      }
    });
    window.addEventListener('beforeunload', (e)=>{
      if (state.screen==='test'){ e.preventDefault(); e.returnValue = 'Sair agora apagará o progresso do teste.'; }
    });

    // BOOT
    render();
  </script>
</body>
</html>
