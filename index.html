<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M@T Digital - Teste de Alteração da Memória</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Bibliotecas para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
        }
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 600px;
        }
        @media (min-width: 640px) {
            .card {
                padding: 2.5rem;
            }
        }
        .btn {
            display: inline-block;
            padding: 0.875rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            text-align: center;
            color: white;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            border: none;
            user-select: none;
        }
        .btn-primary {
            background-color: var(--primary-color);
        }
        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-hover);
        }
        .btn-secondary {
            background-color: #6b7280;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .btn-disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .option-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }
        @media (min-width: 640px) {
            .option-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .option-btn {
            width: 100%;
            padding: 1rem;
            border: 2px solid #d1d5db;
            border-radius: 0.75rem;
            font-size: 1rem;
            text-align: left;
            background-color: #f9fafb;
            cursor: pointer;
            transition: all 0.2s;
        }
        .option-btn:hover:not(:disabled) {
            background-color: #f3f4f6;
            border-color: var(--primary-color);
        }
        .option-btn.selected {
            background-color: #dbeafe;
            border-color: var(--primary-color);
            font-weight: 600;
        }
        .option-btn:disabled {
            background-color: #e5e7eb;
            cursor: not-allowed;
            color: #9ca3af;
            opacity: 0.7;
        }
        .option-btn.correct {
            background-color: #dcfce7;
            border-color: #22c55e;
            color: #166534;
            font-weight: 600;
        }
        .option-btn.incorrect {
            background-color: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }
        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        .progress-bar-container {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            height: 0.5rem;
            margin: 1.5rem 0;
        }
        .progress-bar {
            background-color: var(--primary-color);
            height: 100%;
            border-radius: 9999px;
            transition: width 0.3s ease-in-out;
        }
        .audio-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            background-color: #fef3c7;
            border: 1px solid #fbbf24;
            border-radius: 9999px;
            font-size: 0.875rem;
            color: #92400e;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .alert {
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .alert-info {
            background-color: #dbeafe;
            border: 1px solid #60a5fa;
            color: #1e40af;
        }
        .alert-warning {
            background-color: #fef3c7;
            border: 1px solid #fbbf24;
            color: #92400e;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="app" class="card">
        <!-- Conteúdo dinâmico da aplicação -->
    </div>

    <script>
    // --- CONFIGURAÇÕES E ESTADO GLOBAL ---
    const testData = {
        version: "MAT-Digital 2.2.0",
        blocks: {
            codificacao: [
                { type: 'instruction', text: 'Agora, vou dizer 5 palavras. Ouça com atenção e tente memorizá-las.' },
                { type: 'word_presentation', item: 'Cereja' },
                { type: 'word_presentation', item: 'Machado' },
                { type: 'word_presentation', item: 'Elefante' },
                { type: 'word_presentation', item: 'Piano' },
                { type: 'word_presentation', item: 'Verde' },
                { type: 'instruction', text: 'Agora, por favor, me diga as palavras que você se lembra.' },
                { 
                    type: 'question_mc', 
                    prompt: 'Eu lhe disse o nome de uma fruta, qual era?', 
                    options: ['Maçã', 'Cereja', 'Banana', 'Uva'],
                    answer: 'Cereja',
                    cue: 'Qual era a fruta?'
                },
                { 
                    type: 'question_mc', 
                    prompt: 'Eu lhe disse o nome de uma ferramenta, qual era?', 
                    options: ['Serrote', 'Alicate', 'Machado', 'Martelo'],
                    answer: 'Machado',
                    cue: 'Qual era a ferramenta?'
                },
                { 
                    type: 'question_mc', 
                    prompt: 'Eu lhe disse o nome de um animal, qual era?', 
                    options: ['Cachorro', 'Gato', 'Leão', 'Elefante'],
                    answer: 'Elefante',
                    cue: 'Qual era o animal?'
                },
                { 
                    type: 'question_mc', 
                    prompt: 'Eu lhe disse o nome de um instrumento musical, qual era?', 
                    options: ['Violino', 'Piano', 'Flauta', 'Bateria'],
                    answer: 'Piano',
                    cue: 'Qual era o instrumento musical?'
                },
                { 
                    type: 'question_mc', 
                    prompt: 'Eu lhe disse o nome de uma cor, qual era?', 
                    options: ['Azul', 'Vermelho', 'Verde', 'Amarelo'],
                    answer: 'Verde',
                    cue: 'Qual era a cor?'
                },
                { type: 'instruction', text: 'Muito bem. Agora ouça com atenção a primeira frase.' },
                { type: 'sentence_presentation', sentence: 'Trinta gatos cinzas comeram todo o queijo.' },
                { 
                    type: 'sentence_questions',
                    sentence_ref: 'Trinta gatos cinzas comeram todo o queijo.',
                    questions: [
                        { prompt: 'Da frase sobre os gatos, quantos gatos eram?', options: ['Vinte', 'Trinta', 'Quarenta'], answer: 'Trinta' },
                        { prompt: 'Qual era a cor dos gatos?', options: ['Pretos', 'Brancos', 'Cinzas'], answer: 'Cinzas' },
                        { prompt: 'O que eles comeram?', options: ['Ração', 'Peixe', 'Queijo'], answer: 'Queijo' },
                    ],
                    recall_items: ['Trinta', 'Cinzas', 'Queijo']
                },
                { type: 'instruction', text: 'Ótimo. Agora ouça a segunda frase.' },
                { type: 'sentence_presentation', sentence: 'Um garoto chamado Luís estava brincando com sua bicicleta.' },
                { 
                    type: 'sentence_questions',
                    sentence_ref: 'Um garoto chamado Luís estava brincando com sua bicicleta.',
                    questions: [
                        { prompt: 'Da frase sobre o garoto, qual era o nome dele?', options: ['Pedro', 'Luís', 'João'], answer: 'Luís' },
                        { prompt: 'Com o que ele estava brincando?', options: ['Bola', 'Carrinho', 'Bicicleta'], answer: 'Bicicleta' },
                    ],
                    recall_items: ['Luís', 'Bicicleta']
                },
            ],
            orientacao: [
                { type: 'question_mc', prompt: 'Que dia da semana é hoje?', get_options: 'dayOfWeek', get_answer: 'dayOfWeek' },
                { type: 'question_mc', prompt: 'Em que mês estamos?', get_options: 'month', get_answer: 'month' },
                { type: 'question_input', prompt: 'Qual é o dia do mês?', input_type: 'number', get_answer: 'dayOfMonth' },
                { type: 'question_input', prompt: 'Em que ano estamos?', input_type: 'number', get_answer: 'year' },
                { type: 'question_mc', prompt: 'Qual é a estação do ano?', get_options: 'season', get_answer: 'season' },
            ],
            semantica: [
                { type: 'question_mc', prompt: 'Qual profissional conserta carros?', options: ['Mecânico', 'Eletricista', 'Encanador', 'Padeiro', 'Jardineiro'], answer: 'Mecânico' },
                { type: 'question_mc', prompt: 'Qual é o último dia do ano?', options: ['31 de Dezembro', '30 de Dezembro', '1 de Janeiro', '25 de Dezembro', '31 de Janeiro'], answer: '31 de Dezembro' },
                { type: 'question_mc', prompt: 'Quantas gramas há em um quarto de quilo?', options: ['250g', '500g', '100g', '750g', '1000g'], answer: '250g' },
                { type: 'question_mc', prompt: 'Qual é o oitavo mês do ano?', options: ['Agosto', 'Setembro', 'Julho', 'Outubro', 'Junho'], answer: 'Agosto' },
                { type: 'question_mc', prompt: 'Em que mês comemoramos o Natal?', options: ['Novembro', 'Janeiro', 'Dezembro', 'Fevereiro', 'Março'], answer: 'Dezembro' },
                { type: 'question_mc', prompt: 'Se o ponteiro grande de um relógio está no 11, quantos minutos ele marca?', options: ['55 minutos', '11 minutos', '50 minutos', '5 minutos', '60 minutos'], answer: '55 minutos' },
                { type: 'question_mc', prompt: 'Qual estação do ano vem depois do verão?', options: ['Outono', 'Inverno', 'Primavera'], answer: 'Outono' },
                { type: 'question_mc', prompt: 'Que animal rasteja e não tem patas?', options: ['Cachorro', 'Pássaro', 'Serpente', 'Peixe', 'Minhoca'], answer: 'Serpente' },
                { type: 'question_mc', prompt: 'Azeitona vem de qual árvore?', options: ['Videira', 'Oliveira', 'Macieira', 'Cerejeira', 'Laranjeira'], answer: 'Oliveira' },
                { type: 'question_mc', prompt: 'De qual fruto se faz o chocolate?', options: ['Café', 'Cacau', 'Morango', 'Cana-de-açúcar', 'Soja'], answer: 'Cacau' },
                { type: 'question_mc', prompt: 'Qual o triplo de doze?', options: ['24', '36', '48', '30', '15'], answer: '36' },
                { type: 'question_mc', prompt: 'Quantas horas há em dois dias?', options: ['24 horas', '36 horas', '48 horas', '72 horas', '60 horas'], answer: '48 horas' },
                { type: 'question_mc', prompt: 'O que usamos para escrever em um quadro negro?', options: ['Caneta', 'Giz', 'Lápis', 'Pincel', 'Tinta'], answer: 'Giz' },
                { type: 'question_mc', prompt: 'Qual é a capital do Brasil?', options: ['Rio de Janeiro', 'São Paulo', 'Brasília', 'Salvador', 'Belo Horizonte'], answer: 'Brasília' },
                { type: 'question_mc', prompt: 'Quantos lados tem um triângulo?', options: ['Três', 'Quatro', 'Cinco'], answer: 'Três' },
            ],
        }
    };
    const app = document.getElementById('app');
    const { jsPDF } = window.jspdf;
    let state = {};
    let currentAudio = null;

    // --- SISTEMA DE TTS MELHORADO ---
    class TTSManager {
        constructor() {
            this.cache = new Map();
            this.isPlaying = false;
        }

        async speak(text, onEndCallback = null) {
            if (this.isPlaying && currentAudio) {
                currentAudio.pause();
                currentAudio = null;
                this.isPlaying = false;
            }

            try {
                const cacheKey = `google_translate_${text}`;
                let audioUrl;

                if (this.cache.has(cacheKey)) {
                    audioUrl = this.cache.get(cacheKey);
                } else {
                    audioUrl = this.getGoogleTranslateAudio(text);
                    this.cache.set(cacheKey, audioUrl);
                }

                await this.playAudio(text, audioUrl, onEndCallback);

            } catch (error) {
                console.error('Erro no TTS (Google Translate):', error);
                await this.useBrowserTTS(text, onEndCallback);
            }
        }

        getGoogleTranslateAudio(text) {
            return `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(text)}&tl=pt-BR&client=tw-ob`;
        }
        
        async useBrowserTTS(text, onEndCallback) {
            if (!window.speechSynthesis) {
                console.error('Browser TTS não suportado');
                if (onEndCallback) onEndCallback();
                return;
            }
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'pt-BR';
            utterance.rate = 1.1;
            
            const setVoice = () => {
                const voices = window.speechSynthesis.getVoices();
                // Prioriza vozes de alta qualidade (Safari/iOS) e depois padrões pt-BR
                const ptVoices = voices.filter(v => v.lang.startsWith('pt-BR'));
                const premiumVoice = ptVoices.find(v => v.name.includes('Luciana') || v.name.includes('Felipe')); // Nomes comuns em sistemas Apple
                const defaultVoice = ptVoices.find(v => v.default);
                
                utterance.voice = premiumVoice || defaultVoice || ptVoices[0];

                if (onEndCallback) {
                    utterance.onend = onEndCallback;
                }
                
                window.speechSynthesis.speak(utterance);
            };

            if (window.speechSynthesis.getVoices().length === 0 && 'onvoiceschanged' in window.speechSynthesis) {
                window.speechSynthesis.onvoiceschanged = setVoice;
            } else {
                setVoice();
            }
        }

        async playAudio(originalText, url, onEndCallback) {
            return new Promise((resolve) => {
                currentAudio = new Audio(url);
                this.isPlaying = true;
                currentAudio.onended = () => {
                    this.isPlaying = false;
                    if (onEndCallback) onEndCallback();
                    resolve();
                };
                currentAudio.onerror = (e) => {
                    console.error('Erro ao tocar áudio da API Google:', e);
                    this.isPlaying = false;
                    this.useBrowserTTS(originalText, onEndCallback);
                    resolve();
                };
                currentAudio.play().catch(error => {
                    console.error('Erro ao iniciar reprodução:', error);
                    this.isPlaying = false;
                    this.useBrowserTTS(originalText, onEndCallback);
                    resolve();
                });
            });
        }
    }
    const ttsManager = new TTSManager();

    // --- FUNÇÕES AUXILIARES ---
    const speak = (text, onEndCallback = null) => {
        const indicator = document.getElementById('audio-indicator');
        if (indicator) indicator.style.display = 'inline-flex';
        
        ttsManager.speak(text, () => {
            if (indicator) indicator.style.display = 'none';
            if (onEndCallback) onEndCallback();
        });
    };

    const shuffleArray = (array) => {
        const arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    };

    const getDynamicAnswers = (type) => {
        const now = new Date();
        const weekDays = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];
        const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        const seasons = ['Verão', 'Outono', 'Inverno', 'Primavera'];
        
        const month = now.getMonth();
        let season;
        // Aproximação para Hemisfério Sul
        if (month <= 2 || month === 11) season = 'Verão';
        else if (month >= 3 && month <= 5) season = 'Outono';
        else if (month >= 6 && month <= 8) season = 'Inverno';
        else season = 'Primavera';

        switch(type) {
            case 'dayOfWeek': return { options: weekDays, answer: weekDays[now.getDay()] };
            case 'month': return { options: months, answer: months[now.getMonth()] };
            case 'season': return { options: seasons, answer: season };
            case 'dayOfMonth': return { answer: now.getDate().toString() };
            case 'year': return { answer: now.getFullYear().toString() };
            default: return {};
        }
    };

    // --- INICIALIZAÇÃO ---
    const init = () => {
        resetState();
        render();
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && state.screen === 'test') {
                state.qcFlags.push(`Usuário saiu da aba às ${new Date().toLocaleTimeString('pt-BR')}`);
            }
        });
        window.addEventListener('beforeunload', (e) => {
            if (state.screen === 'test') {
                e.preventDefault();
                e.returnValue = 'Você tem certeza que deseja sair? O progresso do teste será perdido.';
            }
        });
    };

    const resetState = () => {
        state = {
            screen: 'welcome',
            profile: { age: '', education: '' },
            block: null,
            itemIndex: 0,
            subItemIndex: 0,
            answers: {},
            scores: { codificacao: 0, orientacao: 0, semantica: 0, recuperacao_livre: 0, recuperacao_pistas: 0 },
            startTime: null,
            endTime: null,
            qcFlags: [],
            recallStep: 'words',
            itemsToRecall: [],
            selectedAnswer: null,
            lastActionTime: null,
            isFeedbackActive: false,
            testFlow: ['codificacao', 'orientacao', 'semantica', 'free_recall', 'cued_recall'],
            responseTimings: []
        };
    };

    // --- LÓGICA DE NAVEGAÇÃO E PROCESSAMENTO ---
    const startTest = () => {
        state.startTime = new Date();
        state.screen = 'test';
        state.block = state.testFlow[0];
        state.itemIndex = 0;
        state.subItemIndex = 0;
        
        const recallWords = testData.blocks.codificacao.filter(i => i.type === 'question_mc').map(i => ({ cue: i.cue, answer: i.answer, recalled: false, source: 'word' }));
        const recallSentences = testData.blocks.codificacao.filter(i => i.type === 'sentence_questions').flatMap((s, idx) => s.recall_items.map(ri => ({ cue: `Da frase sobre "${idx === 0 ? 'gatos' : 'o garoto'}"`, answer: ri, recalled: false, source: `sentence_${idx+1}` })));
        state.itemsToRecall = [...recallWords, ...recallSentences];
        render();
    };

    const nextItem = () => {
        state.selectedAnswer = null;
        state.lastActionTime = new Date();
        const currentBlockData = testData.blocks[state.block];
        if (state.block === 'codificacao') {
            const currentItem = currentBlockData?.[state.itemIndex];
            if (currentItem?.type === 'sentence_questions' && state.subItemIndex < currentItem.questions.length - 1) {
                state.subItemIndex++;
            } else {
                state.itemIndex++;
                state.subItemIndex = 0;
            }
        } else {
            state.itemIndex++;
        }
        if (!currentBlockData || state.itemIndex >= currentBlockData.length) {
            const currentBlockIndex = state.testFlow.indexOf(state.block);
            if (currentBlockIndex < state.testFlow.length - 1) {
                state.block = state.testFlow[currentBlockIndex + 1];
                state.itemIndex = 0;
                state.subItemIndex = 0;
            } else {
                state.endTime = new Date();
                state.screen = 'results';
            }
        }
        render();
    };
    
    const processAnswer = (answer, advance = true) => {
        const rt = new Date() - state.lastActionTime;
        state.responseTimings.push({ block: state.block, item: state.itemIndex, responseTime: rt, answer: answer });
        if (rt < 300) {
            state.qcFlags.push(`Resposta muito rápida (${rt}ms) em ${state.block}-${state.itemIndex}`);
        }
        
        const currentBlockName = state.block;
        const currentItem = testData.blocks[currentBlockName]?.[state.itemIndex];
        if (!currentItem) return;
        
        let correctAnswer;
        if (currentItem.get_answer) {
            correctAnswer = getDynamicAnswers(currentItem.get_answer).answer;
        } else if (currentItem.type === 'sentence_questions') {
            correctAnswer = currentItem.questions[state.subItemIndex].answer;
        } else {
            correctAnswer = currentItem.answer;
        }
        
        const isCorrect = String(answer).trim().toLowerCase() === String(correctAnswer).trim().toLowerCase();
        if (isCorrect) {
            state.scores[currentBlockName]++;
        }
        
        const answerKey = `${currentBlockName}-${state.itemIndex}-${state.subItemIndex}`;
        state.answers[answerKey] = { given: answer, correct: correctAnswer, isCorrect: isCorrect, responseTime: rt };
        
        if (advance) {
            nextItem();
        }
    };
    
    const processFreeRecall = (recalledItems, source) => {
        recalledItems.forEach(item => {
            const match = state.itemsToRecall.find(i => i.source === source && i.answer.toLowerCase() === item.toLowerCase() && !i.recalled);
            if (match) {
                match.recalled = 'free';
                state.scores.recuperacao_livre++;
            }
        });
    };
    
    const processCuedRecallAnswer = (answer, item) => {
        const originalItem = state.itemsToRecall.find(i => i.answer === item.answer && i.cue === item.cue);
        if (originalItem && !originalItem.recalled) {
            const isCorrect = answer.toLowerCase() === originalItem.answer.toLowerCase();
            if (isCorrect) {
                state.scores.recuperacao_pistas++;
            }
            // ESSENCIAL: Marca o item como 'tentado' para avançar, independentemente da resposta
            originalItem.recalled = 'attempted';
        }
        // Re-render para mostrar a próxima pergunta com pista ou avançar para os resultados
        render();
    };

    // --- FUNÇÕES DE RENDERIZAÇÃO ---
    const render = () => {
        app.innerHTML = '';
        switch(state.screen) {
            case 'welcome': renderWelcome(); break;
            case 'profile': renderProfile(); break;
            case 'instructions': renderInstructions(); break;
            case 'test': renderTest(); break;
            case 'results': renderResults(); break;
        }
    };
    
    const renderHeader = (title, showProgress = true) => {
        let progress = 0;
        if (showProgress && state.block) {
            const totalItems = Object.values(testData.blocks).reduce((acc, val) => acc + val.length, 0) + 10;
            const currentBlockIndex = state.testFlow.indexOf(state.block);
            const itemsDoneInPrevBlocks = state.testFlow.slice(0, currentBlockIndex)
                .filter(b => testData.blocks[b])
                .reduce((acc, blockKey) => acc + testData.blocks[blockKey].length, 0);
            progress = Math.min(100, ((itemsDoneInPrevBlocks + state.itemIndex) / totalItems) * 100);
        }
        return `
            <h1 class="text-2xl font-bold text-gray-800 mb-2">${title}</h1>
            ${showProgress ? `
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: ${progress}%"></div>
            </div>` : '<div class="mb-6"></div>'}
            <div id="audio-indicator" class="audio-indicator" style="display: none;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18V5l12-2v13"></path>
                    <circle cx="6" cy="18" r="3"></circle>
                    <circle cx="18" cy="16" r="3"></circle>
                </svg>
                <span>Reproduzindo áudio...</span>
            </div>
        `;
    };

    const renderWelcome = () => {
        app.innerHTML = `
            <div class="text-center">
                <h1 class="text-3xl font-bold text-gray-800 mb-3">M@T Digital</h1>
                <p class="text-lg text-gray-600 mb-6">Teste de Alteração da Memória</p>
                
                <div class="alert alert-info text-left mb-6">
                    <p class="font-semibold mb-2">📢 Importante:</p>
                    <ul class="list-disc list-inside space-y-1 text-sm">
                        <li>Encontre um local silencioso e sem distrações.</li>
                        <li>O teste leva aproximadamente 10-15 minutos.</li>
                        <li>As instruções serão faladas e escritas.</li>
                        <li>Certifique-se de que o som está ativado.</li>
                    </ul>
                </div>
                                
                <button data-action="start_profile" class="btn btn-primary w-full mt-4">
                    Iniciar Teste
                </button>
            </div>
        `;
    };

    const renderProfile = () => {
        app.innerHTML = `
            ${renderHeader('Informações do Participante', false)}
            <div class="space-y-4">
                <div>
                    <label for="age" class="block text-sm font-medium text-gray-700 mb-1">
                        Idade (anos completos) <span class="text-red-500">*</span>
                    </label>
                    <input type="number" id="age" class="input-field" value="${state.profile.age}" min="18" max="120" required>
                </div>
                <div>
                    <label for="education" class="block text-sm font-medium text-gray-700 mb-1">
                        Escolaridade (anos de estudo) <span class="text-red-500">*</span>
                    </label>
                    <input type="number" id="education" class="input-field" value="${state.profile.education}" min="0" max="30" required>
                    <p class="help-text">Informe o total de anos de educação formal completados.</p>
                </div>
            </div>
            <div id="profile-error" class="text-red-600 text-sm mt-4 min-h-[20px]"></div>
            <div class="mt-6 flex gap-3 justify-end">
                <button data-action="back_to_welcome" class="btn btn-secondary">Voltar</button>
                <button data-action="start_instructions" class="btn btn-primary">Continuar</button>
            </div>
        `;
    };
    
    const renderInstructions = () => {
        const text = 'O teste começará agora. Você verá e ouvirá palavras, frases e perguntas. Responda tocando nos botões. Se não souber uma resposta, escolha "Não me recordo", quando disponível. Faça o seu melhor.';
        app.innerHTML = `
            ${renderHeader('Instruções', false)}
            <div class="space-y-4">
                <p class="text-lg text-gray-700">${text}</p>
                <div class="alert alert-warning">
                    <p class="font-semibold">⚠️ Atenção:</p>
                    <p class="text-sm mt-1">Não use o botão "voltar" do navegador ou recarregue a página, pois isso resultará na perda do progresso.</p>
                </div>
            </div>
            <div class="mt-8 flex gap-3 justify-end">
                <button data-action="back_to_profile" class="btn btn-secondary">Voltar</button>
                <button data-action="start_test" class="btn btn-primary">Começar o Teste</button>
            </div>
        `;
        speak(text);
    };

    const renderTest = () => {
        state.lastActionTime = new Date();
        const block = state.block;
        switch(block) {
            case 'codificacao':
            case 'orientacao':
            case 'semantica':
                renderQuestionBlock(block);
                break;
            case 'free_recall':
                renderFreeRecall();
                break;
            case 'cued_recall':
                renderCuedRecall();
                break;
        }
    };

    const renderQuestionBlock = (blockName) => {
        const item = testData.blocks[blockName][state.itemIndex];
        if (!item) {
            nextItem();
            return;
        }
        let content = '';
        switch(item.type) {
            case 'instruction':
                content = `<p class="text-xl text-center my-8">${item.text}</p><div class="text-center mt-8"><button data-action="next_item" class="btn btn-primary">Continuar</button></div>`;
                speak(item.text);
                break;
            case 'word_presentation':
                content = `<div class="text-center my-16"><h2 class="text-5xl font-bold text-gray-800">${item.item}</h2></div>`;
                speak(item.item, () => { setTimeout(nextItem, 500); });
                break;
            case 'sentence_presentation':
                content = `<div class="text-center my-12 px-4"><h2 class="text-3xl font-semibold text-gray-800 leading-relaxed">${item.sentence}</h2></div>`;
                speak(item.sentence, () => { setTimeout(nextItem, 1500); });
                break;
            case 'question_mc':
            case 'sentence_questions':
            case 'question_input':
                content = renderQuestion(item, blockName);
                break;
        }
        app.innerHTML = content;
    };
    
    const renderQuestion = (item, blockName) => {
        let prompt, options = [], questionType, inputType;
        if (item.type === 'sentence_questions') {
            const subQuestion = item.questions[state.subItemIndex];
            prompt = subQuestion.prompt;
            options = subQuestion.options;
            questionType = 'mc';
        } else {
            prompt = item.prompt;
            questionType = item.type.includes('mc') ? 'mc' : 'input';
            if (questionType === 'mc') {
                options = item.get_options ? getDynamicAnswers(item.get_options).options : [...item.options];
                options = shuffleArray(options);
                if (!options.includes("Não me recordo")) options.push("Não me recordo");
            } else {
                inputType = item.input_type || 'text';
            }
        }
        
        speak(prompt);
        const titleMap = { codificacao: 'Memorização', orientacao: 'Orientação no Tempo', semantica: 'Conhecimentos Gerais' };
        return `
            ${renderHeader(titleMap[blockName] || 'Teste')}
            <p class="text-xl text-gray-700 mb-6 min-h-[60px]">${prompt}</p>
            ${questionType === 'mc' ? `
            <div class="option-grid">
                ${options.map(opt => `<button data-action="select_option" data-value="${opt}" class="option-btn ${state.selectedAnswer === opt ? 'selected' : ''}">${opt}</button>`).join('')}
            </div>` : `
            <div><input type="${inputType}" id="input-answer" class="input-field" placeholder="Digite sua resposta" autocomplete="off"></div>`}
            <div class="mt-8 text-right">
                <button data-action="submit_answer" class="btn btn-primary ${questionType === 'mc' && !state.selectedAnswer ? 'btn-disabled' : ''}" ${questionType === 'mc' && !state.selectedAnswer ? 'disabled' : ''}>Confirmar</button>
            </div>
        `;
    };
    
    const renderFreeRecall = () => {
        if (state.recallStep === 'words') {
            renderFreeRecallWords();
        } else {
            renderFreeRecallSentences();
        }
    };
    
    const renderFreeRecallWords = () => {
        const text = "Agora, selecione as 5 palavras que você memorizou no início do teste.";
        app.innerHTML = `
            ${renderHeader('Evocação Livre - Palavras')}
            <p class="text-lg text-gray-700 mb-4">${text}</p>
            <div class="alert alert-info mb-4"><p class="text-sm">Toque para selecionar. Você pode escolher até 5 palavras.</p></div>
            <div id="recall-grid" class="grid grid-cols-2 sm:grid-cols-4 gap-3"></div>
            <div class="mt-3 text-right"><span class="text-sm text-gray-600">Selecionadas: <span id="selection-count" class="font-bold">0</span> / 5</span></div>
            <div class="mt-6 text-right"><button data-action="submit_free_word_recall" class="btn btn-primary">Confirmar Seleção</button></div>
        `;
        speak(text);
        
        const words = state.itemsToRecall.filter(i => i.source === 'word').map(i => i.answer);
        const distractors = ['Maçã','Martelo','Cachorro','Violino','Azul','Pera','Chave','Tigre','Harpa','Roxo','Copo','Livro','Porta','Caneta','Garfo'];
        const options = shuffleArray([...words, ...shuffleArray(distractors).slice(0, 15)]);
        
        const grid = document.getElementById('recall-grid');
        grid.innerHTML = options.map(opt => `<button data-action="toggle_recall_item" data-type="word" class="option-btn text-center">${opt}</button>`).join('');
    };
    
    const renderFreeRecallSentences = () => {
        const text = "Agora, selecione as palavras que você se lembra das duas frases apresentadas.";
        app.innerHTML = `
            ${renderHeader('Evocação Livre - Frases')}
            <p class="text-lg text-gray-700 mb-4">${text}</p>
            <div class="alert alert-info mb-4"><p class="text-sm">Selecione todas as palavras que você lembrar.</p></div>
            <div id="recall-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
            <div class="mt-6 text-right"><button data-action="submit_free_sentence_recall" class="btn btn-primary">Confirmar e Continuar</button></div>
        `;
        speak(text);
        
        const sentenceItems = state.itemsToRecall.filter(i => i.source.startsWith('sentence')).map(i => i.answer);
        const distractors = ['Vinte','Pretos','Ração','Pedro','Bola','Cão','Gata','Quarenta'];
        const options = shuffleArray([...sentenceItems, ...distractors]);
        
        const grid = document.getElementById('recall-grid');
        grid.innerHTML = options.map(opt => `<button data-action="toggle_recall_item" data-type="sentence" class="option-btn text-center">${opt}</button>`).join('');
    };

    const renderCuedRecall = () => {
        const itemsForCuedRecall = state.itemsToRecall.filter(item => !item.recalled);
        if (itemsForCuedRecall.length === 0) {
            nextItem();
            return;
        }
        const item = itemsForCuedRecall[0];
        
        const distractorMap = {
            'fruta': ['Maçã', 'Banana', 'Uva'], 'ferramenta': ['Serrote', 'Martelo', 'Alicate'],
            'animal': ['Gato', 'Leão', 'Cachorro'], 'instrumento': ['Violino', 'Flauta', 'Guitarra'],
            'cor': ['Azul', 'Amarelo', 'Vermelho'], 'gatos': ['Vinte', 'Pretos', 'Ração'],
            'garoto': ['Pedro', 'Bola', 'Carrinho']
        };
        let cueKey = item.cue.toLowerCase().replace(/[:?]/g, '');
        const key = Object.keys(distractorMap).find(k => cueKey.includes(k));
        const distractors = (key ? distractorMap[key] : ['Opção A', 'Opção B']).filter(d => d !== item.answer);
        
        const options = shuffleArray([item.answer, ...shuffleArray(distractors).slice(0, 3), 'Não me recordo']);
        
        speak(item.cue);
        app.innerHTML = `
            ${renderHeader('Evocação com Pistas')}
            <p class="text-xl text-gray-700 mb-6">${item.cue}</p>
            <div class="option-grid">
                ${options.map(opt => `<button data-action="select_option" data-value="${opt}" class="option-btn ${state.selectedAnswer === opt ? 'selected' : ''}">${opt}</button>`).join('')}
            </div>
            <div class="mt-8 text-right">
                 <button data-action="submit_cued_recall" data-item='${JSON.stringify(item)}' class="btn btn-primary ${!state.selectedAnswer ? 'btn-disabled' : ''}" ${!state.selectedAnswer ? 'disabled' : ''}>Confirmar</button>
            </div>
        `;
    };

    const renderResults = () => {
        const totalScore = Object.values(state.scores).reduce((sum, score) => sum + score, 0);
        const duration = Math.round((state.endTime - state.startTime) / 1000);
        const minutes = Math.floor(duration / 60);
        const seconds = duration % 60;

        const scoreRow = (label, score, max, isTotal = false) => `
            <div class="flex justify-between items-center ${isTotal ? 'bg-blue-100' : 'bg-gray-50'} p-3 rounded-lg ${isTotal ? 'border-2 border-blue-300' : ''}">
                <span class="${isTotal ? 'font-bold text-blue-800' : 'font-semibold text-gray-700'}">${label}</span>
                <span class="${isTotal ? 'text-xl font-bold text-blue-800' : 'text-lg font-bold text-gray-800'}">${score} / ${max}</span>
            </div>
        `;
        
        app.innerHTML = `
            <div class="text-center">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Teste Concluído!</h1>
                <p class="text-gray-600 mb-6">Tempo total: ${minutes}m ${seconds}s</p>
            </div>
            <div class="space-y-3">
                ${scoreRow('Memorização (Codificação)', state.scores.codificacao, 10)}
                ${scoreRow('Orientação no Tempo', state.scores.orientacao, 5)}
                ${scoreRow('Conhecimentos Gerais', state.scores.semantica, 15)}
                ${scoreRow('Evocação Livre', state.scores.recuperacao_livre, 10)}
                ${scoreRow('Evocação com Pistas', state.scores.recuperacao_pistas, 10)}
                ${scoreRow('PONTUAÇÃO TOTAL', totalScore, 50, true)}
            </div>
            ${state.qcFlags.length > 0 ? `
            <div class="mt-6 p-3 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded">
                <h4 class="font-bold mb-2">⚠️ Observações de Qualidade</h4>
                <ul class="list-disc list-inside text-sm space-y-1">${state.qcFlags.map(f => `<li>${f}</li>`).join('')}</ul>
            </div>` : ''}
            <div class="mt-8">
                <h3 class="text-lg font-semibold mb-3 text-center">📥 Exportar Resultados</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                    <button data-action="export_pdf" class="btn btn-secondary">📄 PDF</button>
                    <button data-action="export_json" class="btn btn-secondary">💾 JSON</button>
                    <button data-action="export_csv" class="btn btn-secondary">📊 CSV</button>
                </div>
            </div>
            <div class="mt-8 text-center">
                <button data-action="restart" class="btn btn-primary">🔄 Novo Teste</button>
            </div>
             <div class="mt-6 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800">
                <p class="font-semibold mb-1">📋 Nota Importante:</p>
                <p>Este é um teste de rastreio cognitivo. A interpretação dos resultados deve ser realizada por um profissional de saúde qualificado.</p>
            </div>
        `;
    };

    // --- FUNÇÕES DE EXPORTAÇÃO ---
    const getExportData = () => {
        const totalScore = Object.values(state.scores).reduce((sum, score) => sum + score, 0);
        return {
            testVersion: testData.version,
            testDate: state.startTime.toISOString(),
            durationSeconds: Math.round((state.endTime - state.startTime) / 1000),
            profile: state.profile,
            scores: {
                codificacao: { score: state.scores.codificacao, max: 10 },
                orientacao: { score: state.scores.orientacao, max: 5 },
                semantica: { score: state.scores.semantica, max: 15 },
                recuperacao_livre: { score: state.scores.recuperacao_livre, max: 10 },
                recuperacao_pistas: { score: state.scores.recuperacao_pistas, max: 10 },
                total: { score: totalScore, max: 50 }
            },
            qualityFlags: state.qcFlags,
            detailedAnswers: state.answers,
            recallDetails: state.itemsToRecall,
            responseTimings: state.responseTimings
        };
    };

    const downloadFile = (filename, content, type) => {
        const blob = new Blob([content], { type });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    const exportJSON = () => {
        const data = getExportData();
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        downloadFile(`MAT_Digital_${timestamp}.json`, JSON.stringify(data, null, 2), 'application/json');
    };

    const exportCSV = () => {
        const data = getExportData();
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        
        let csv = 'Domínio,Pontuação,Máximo,Percentual\n';
        Object.entries(data.scores).forEach(([key, value]) => {
            const percent = ((value.score / value.max) * 100).toFixed(1);
            const label = key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
            csv += `${label},${value.score},${value.max},${percent}%\n`;
        });
        
        csv += '\nPerfil\n';
        csv += `Idade,${data.profile.age}\n`;
        csv += `Escolaridade,${data.profile.education}\n`;
        csv += `Data,${new Date(data.testDate).toLocaleString('pt-BR')}\n`;
        
        downloadFile(`MAT_Digital_${timestamp}.csv`, csv, 'text/csv;charset=utf-8;');
    };

    const exportPDF = () => {
        const data = getExportData();
        const doc = new jsPDF();
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');

        doc.setFontSize(20);
        doc.setFont('helvetica', 'bold');
        doc.text("M@T Digital - Relatório de Resultados", 105, 20, { align: 'center' });
        doc.setFontSize(12);
        doc.text(`Data: ${new Date(data.testDate).toLocaleString('pt-BR')}`, 20, 45);
        
        const tableData = Object.entries(data.scores).map(([key, value]) => {
            const label = key.charAt(0).toUpperCase() + key.slice(1);
            return [label, `${value.score} / ${value.max}`];
        });
        
        doc.autoTable({
            startY: 55,
            head: [['Domínio', 'Pontuação']],
            body: tableData,
            theme: 'grid'
        });

        if (data.qualityFlags.length > 0) {
            let y = doc.autoTable.previous.finalY + 15;
            doc.text("Observações de Qualidade:", 20, y);
            y += 8;
            data.qualityFlags.forEach(flag => {
                doc.text(`- ${flag}`, 25, y);
                y += 7;
            });
        }
        
        doc.save(`MAT_Digital_${timestamp}.pdf`);
    };

    // --- EVENT DELEGATION ---
    app.addEventListener('click', (e) => {
        const target = e.target.closest('[data-action]');
        if (!target) return;
        e.preventDefault();
        const action = target.dataset.action;

        switch(action) {
            case 'start_profile':
                state.screen = 'profile';
                render();
                break;
            case 'back_to_welcome':
                state.screen = 'welcome';
                render();
                break;
            case 'back_to_profile':
                 state.screen = 'profile';
                 render();
                break;
            case 'start_instructions':
                const age = document.getElementById('age').value;
                const education = document.getElementById('education').value;
                const errorDiv = document.getElementById('profile-error');
                if (!age || !education) {
                    errorDiv.textContent = '⚠️ Por favor, preencha todos os campos obrigatórios.';
                    return;
                }
                state.profile.age = age;
                state.profile.education = education;
                state.screen = 'instructions';
                render();
                break;
            case 'start_test':
                startTest();
                break;
            case 'next_item':
                nextItem();
                break;
            case 'select_option':
                state.selectedAnswer = target.dataset.value;
                document.querySelectorAll('[data-action="select_option"]').forEach(btn => btn.classList.remove('selected'));
                target.classList.add('selected');
                const confirmBtn = app.querySelector('[data-action="submit_answer"], [data-action="submit_cued_recall"]');
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.classList.remove('btn-disabled');
                }
                break;
            case 'submit_answer':
                if (state.isFeedbackActive) return;
                let answer;
                const currentItem = testData.blocks[state.block]?.[state.itemIndex];
                if (!currentItem) return;

                if (currentItem.type.includes('input')) {
                    answer = document.getElementById('input-answer')?.value;
                } else {
                    answer = state.selectedAnswer;
                }
                if (!answer || answer.trim() === '') return;

                if (state.block === 'codificacao' && (currentItem.type === 'question_mc' || currentItem.type === 'sentence_questions')) {
                    state.isFeedbackActive = true;
                    target.disabled = true;
                    target.classList.add('btn-disabled');
                    processAnswer(answer, false);
                    
                    const correctAnswer = currentItem.type === 'sentence_questions' ? currentItem.questions[state.subItemIndex].answer : currentItem.answer;
                    const isCorrect = answer.toLowerCase() === correctAnswer.toLowerCase();
                    
                    document.querySelectorAll('.option-btn').forEach(btn => {
                        btn.disabled = true;
                        if (btn.dataset.value.toLowerCase() === correctAnswer.toLowerCase()) {
                            btn.classList.add('correct');
                        } else if (btn.dataset.value === answer && !isCorrect) {
                            btn.classList.add('incorrect');
                        }
                    });
                    
                    const feedbackText = isCorrect ? "Correto!" : `A resposta correta era: ${correctAnswer}`;
                    speak(feedbackText, () => {
                        setTimeout(() => {
                            state.isFeedbackActive = false;
                            nextItem();
                        }, 500);
                    });
                } else {
                    processAnswer(answer, true);
                }
                break;
            case 'toggle_recall_item':
                const type = target.dataset.type;
                if (type === 'word') {
                    const selectedCount = document.querySelectorAll('.option-btn.selected').length;
                    if (target.classList.contains('selected')) {
                        target.classList.remove('selected');
                    } else if (selectedCount < 5) {
                        target.classList.add('selected');
                    }
                    const newCount = document.querySelectorAll('.option-btn.selected').length;
                    document.getElementById('selection-count').textContent = newCount;
                    document.querySelectorAll('.option-btn:not(.selected)').forEach(btn => {
                         btn.disabled = (newCount >= 5);
                         btn.classList.toggle('btn-disabled', newCount >= 5);
                    });
                } else {
                    target.classList.toggle('selected');
                }
                break;
            case 'submit_free_word_recall':
                const selectedWords = [...document.querySelectorAll('#recall-grid .option-btn.selected')].map(btn => btn.textContent.trim());
                processFreeRecall(selectedWords, 'word');
                state.recallStep = 'sentences';
                render();
                break;
            case 'submit_free_sentence_recall':
                const selectedSentenceItems = [...document.querySelectorAll('#recall-grid .option-btn.selected')].map(btn => btn.textContent.trim());
                processFreeRecall(selectedSentenceItems, 'sentence_1');
                processFreeRecall(selectedSentenceItems, 'sentence_2');
                nextItem();
                break;
            case 'submit_cued_recall':
                if (state.selectedAnswer) {
                    processCuedRecallAnswer(state.selectedAnswer, JSON.parse(target.dataset.item));
                }
                break;
            case 'restart':
                if (confirm('Tem certeza que deseja reiniciar?')) {
                    resetState();
                    render();
                }
                break;
            case 'export_pdf': exportPDF(); break;
            case 'export_json': exportJSON(); break;
            case 'export_csv': exportCSV(); break;
        }
    });
    
    app.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && e.target.tagName === 'INPUT') {
            e.preventDefault();
            const submitBtn = document.querySelector('[data-action="submit_answer"]');
            if (submitBtn && !submitBtn.disabled) submitBtn.click();
        }
    });

    init();
    </script>
</body>
</html>
